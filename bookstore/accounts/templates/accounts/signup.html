{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sign Up - Bookstore</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      min-height: 100vh;
    }

    .auth-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      position: relative;
    }

    .auth-box {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border-radius: 30px;
      padding: 50px 40px;
      width: 100%;
      max-width: 550px;
      border: 1px solid rgba(220, 20, 60, 0.2);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .auth-box h2 {
      text-align: center;
      font-size: 2.2em;
      font-weight: 800;
      margin-bottom: 30px;
      background: linear-gradient(45deg, #DC143C, #FF6B6B);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
    }

    .auth-box form label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
    }

    .auth-box form input, .auth-box form textarea, .auth-box form select {
      width: 100%;
      padding: 15px 20px;
      border-radius: 25px;
      border: 2px solid rgba(220, 20, 60, 0.3);
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      color: white;
      font-size: 1em;
      margin-bottom: 20px;
      box-sizing: border-box;
    }

    .auth-box form input:focus, .auth-box form textarea:focus, .auth-box form select:focus {
      outline: none;
      border-color: #DC143C;
      box-shadow: 0 0 20px rgba(220, 20, 60, 0.3);
    }

    .btn-primary {
      width: 100%;
      padding: 15px;
      background: linear-gradient(45deg, #DC143C, #FF6B6B);
      color: white;
      border: none;
      border-radius: 25px;
      font-weight: 700;
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(220, 20, 60, 0.4);
    }

    .btn-secondary {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 2px solid rgba(220, 20, 60, 0.3);
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .btn-secondary:hover {
      background: rgba(220, 20, 60, 0.2);
      border-color: #DC143C;
    }

    .btn-remove {
      background: rgba(255, 69, 0, 0.2);
      border: 2px solid rgba(255, 69, 0, 0.4);
      color: #FF6B6B;
      padding: 8px 16px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 0.9em;
      margin-top: 10px;
    }

    .btn-remove:hover {
      background: rgba(255, 69, 0, 0.3);
    }

    .navbar {
      background: rgba(15, 15, 15, 0.95);
      backdrop-filter: blur(20px);
      padding: 20px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid rgba(220, 20, 60, 0.3);
    }

    .logo {
      font-size: 1.8em;
      font-weight: 800;
      background: linear-gradient(45deg, #DC143C, #FF6B6B);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .nav-buttons {
      display: flex;
      gap: 15px;
    }

    .btn-nav {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      text-decoration: none;
      border-radius: 25px;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 1px solid rgba(220, 20, 60, 0.3);
    }

    .btn-nav:hover {
      background: rgba(220, 20, 60, 0.2);
      box-shadow: 0 5px 15px rgba(220, 20, 60, 0.2);
      border-color: #DC143C;
    }

    .link-text {
      text-align: center;
      margin-top: 25px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.95em;
    }

    .link-text a {
      color: #DC143C;
      text-decoration: none;
      font-weight: 600;
    }

    .card-section {
      margin-bottom: 20px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      border: 1px solid rgba(220, 20, 60, 0.2);
    }

    .card-count {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9em;
      margin-bottom: 10px;
    }

    .floating-shape {
      position: absolute;
      background: linear-gradient(45deg, rgba(220, 20, 60, 0.1), rgba(139, 0, 0, 0.1));
      border-radius: 50%;
      animation: float 6s ease-in-out infinite;
    }

    .floating-shape:nth-child(1) {
      width: 100px;
      height: 100px;
      top: 20%;
      left: 10%;
      animation-delay: 0s;
    }

    .floating-shape:nth-child(2) {
      width: 150px;
      height: 150px;
      top: 50%;
      right: 20%;
      animation-delay: 2s;
    }

    .floating-shape:nth-child(3) {
      width: 80px;
      height: 80px;
      bottom: 30%;
      left: 30%;
      animation-delay: 4s;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
    }

    .messages {
      list-style: none;
      padding: 0;
      margin-bottom: 20px;
    }

    .messages li {
      background: rgba(220, 20, 60, 0.1);
      border: 1px solid rgba(220, 20, 60, 0.3);
      color: #FF6B6B;
      padding: 12px 20px;
      border-radius: 20px;
      margin-bottom: 10px;
      font-size: 0.9em;
      backdrop-filter: blur(10px);
    }

    h3 {
      color: white;
      margin: 25px 0 15px 0;
      font-size: 1.3em;
    }

    hr {
      margin: 20px 0;
      border: none;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    }

    .hidden-card {
      display: none;
    }

    .existing-card {
      display: block;
    }

    .form-errors {
      color: #FF6B6B;
      font-size: 0.9em;
      margin-top: 5px;
      margin-bottom: 10px;
    }

    .required-indicator {
      color: #FF6B6B;
      font-weight: bold;
    }

    .card-form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .card-form-full {
      grid-column: 1 / -1;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      margin-top: 15px;
      margin-bottom: 20px;
    }

    .checkbox-wrapper input[type="checkbox"] {
      width: auto;
      margin-right: 10px;
      margin-bottom: 0;
    }

    .checkbox-wrapper label {
      margin-bottom: 0;
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .field-help-text {
      font-size: 0.8em;
      color: rgba(255, 255, 255, 0.6);
      margin-top: -15px;
      margin-bottom: 15px;
      font-style: italic;
    }
  </style>
</head>
<body>
<!-- Floating background shapes -->
<div class="floating-shape"></div>
<div class="floating-shape"></div>
<div class="floating-shape"></div>

<header class="navbar">
  <div class="logo">Bookstore</div>
  <div class="nav-buttons">
    <a href="{% url 'store_home' %}" class="btn-nav">Home</a>
    <a href="{% url 'login' %}" class="btn-nav">Login</a>
    <a href="{% url 'cart_view' %}" class="btn-nav">Cart</a>
  </div>
</header>

<main class="auth-page">
  <div class="auth-box">
    <h2>üìù Sign Up</h2>

    {% if messages %}
    <ul class="messages">
      {% for message in messages %}
      <li>{{ message }}</li>
      {% endfor %}
    </ul>
    {% endif %}

    <!-- DEBUG: Display form errors -->
    {% if form.errors or address_form.errors %}
    <div class="form-errors">
      <h4>Form Errors:</h4>
      {% if form.errors %}
        <p>User form errors: {{ form.errors }}</p>
      {% endif %}
      {% if address_form.errors %}
        <p>Address errors: {{ address_form.errors }}</p>
      {% endif %}
      {% for card_form in card_forms %}
        {% if card_form.errors %}
          <p>Card {{ forloop.counter }} errors: {{ card_form.errors }}</p>
        {% endif %}
      {% endfor %}
    </div>
    {% endif %}

    <form method="POST">
      {% csrf_token %}

      <h3>Personal Information</h3>
      <label for="{{ form.email.id_for_label }}">Email <span class="required-indicator">*</span>:</label>
      {{ form.email }}
      {% if form.email.errors %}
        <div class="form-errors">{{ form.email.errors }}</div>
      {% endif %}

      <label for="{{ form.first_name.id_for_label }}">First Name <span class="required-indicator">*</span>:</label>
      {{ form.first_name }}
      {% if form.first_name.errors %}
        <div class="form-errors">{{ form.first_name.errors }}</div>
      {% endif %}

      <label for="{{ form.last_name.id_for_label }}">Last Name <span class="required-indicator">*</span>:</label>
      {{ form.last_name }}
      {% if form.last_name.errors %}
        <div class="form-errors">{{ form.last_name.errors }}</div>
      {% endif %}

      <label for="{{ form.phone.id_for_label }}">Phone <span class="required-indicator">*</span>:</label>
      {{ form.phone }}
      {% if form.phone.errors %}
        <div class="form-errors">{{ form.phone.errors }}</div>
      {% endif %}

      <label for="{{ form.password.id_for_label }}">Password <span class="required-indicator">*</span>:</label>
      {{ form.password }}
      {% if form.password.errors %}
        <div class="form-errors">{{ form.password.errors }}</div>
      {% endif %}

      <div class="checkbox-wrapper">
        {{ form.promotions_opt_in }}
        <label for="{{ form.promotions_opt_in.id_for_label }}">
          Register for Promotions
        </label>
      </div>
      {% if form.promotions_opt_in.errors %}
        <div class="form-errors">{{ form.promotions_opt_in.errors }}</div>
      {% endif %}

      <h3>Shipping Address</h3>
      <label for="{{ address_form.street.id_for_label }}">Street Address:</label>
      {{ address_form.street }}
      {% if address_form.street.errors %}
        <div class="form-errors">{{ address_form.street.errors }}</div>
      {% endif %}

      <label for="{{ address_form.city.id_for_label }}">City:</label>
      {{ address_form.city }}
      {% if address_form.city.errors %}
        <div class="form-errors">{{ address_form.city.errors }}</div>
      {% endif %}

      <label for="{{ address_form.state.id_for_label }}">State:</label>
      {{ address_form.state }}
      {% if address_form.state.errors %}
        <div class="form-errors">{{ address_form.state.errors }}</div>
      {% endif %}

      <label for="{{ address_form.zip_code.id_for_label }}">ZIP Code:</label>
      {{ address_form.zip_code }}
      {% if address_form.zip_code.errors %}
        <div class="form-errors">{{ address_form.zip_code.errors }}</div>
      {% endif %}

      <label for="{{ address_form.country.id_for_label }}">Country:</label>
      {{ address_form.country }}
      {% if address_form.country.errors %}
        <div class="form-errors">{{ address_form.country.errors }}</div>
      {% endif %}

      <h3>Payment Cards</h3>
      <div class="card-count">You can add up to 4 payment cards (optional)</div>
      
      <div id="card-container">
        {% for card_form in card_forms %}
        <div class="card-form card-section {% if forloop.first %}existing-card{% else %}hidden-card{% endif %}" id="card-form-{{ forloop.counter0 }}" data-is-existing="false">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <strong style="color: white;">Payment Card {{ forloop.counter }}</strong>
            {% if not forloop.first %}
            <button type="button" class="btn-remove" onclick="removeCard('{{ forloop.counter0 }}')">Remove</button>
            {% endif %}
          </div>
          
          <div class="card-form-grid">
            <div>
              <label for="{{ card_form.card_type.id_for_label }}">Card Type <span class="required-indicator card-required" style="display: none;">*</span>:</label>
              {{ card_form.card_type }}
              {% if card_form.card_type.errors %}
                <div class="form-errors">{{ card_form.card_type.errors }}</div>
              {% endif %}
            </div>
            
            <div>
              <label for="{{ card_form.name.id_for_label }}">Name on Card <span class="required-indicator card-required" style="display: none;">*</span>:</label>
              {{ card_form.name }}
              {% if card_form.name.errors %}
                <div class="form-errors">{{ card_form.name.errors }}</div>
              {% endif %}
            </div>
          </div>
          
          <div class="card-form-full">
            <label for="{{ card_form.card_number.id_for_label }}">Card Number <span class="required-indicator card-required" style="display: none;">*</span>:</label>
            {{ card_form.card_number }}
            {% if card_form.card_number.help_text %}
              <div class="field-help-text">{{ card_form.card_number.help_text }}</div>
            {% endif %}
            {% if card_form.card_number.errors %}
              <div class="form-errors">{{ card_form.card_number.errors }}</div>
            {% endif %}
          </div>
          
          <div class="card-form-grid">
            <div>
              <label for="{{ card_form.expiration_date.id_for_label }}">Expiration Date <span class="required-indicator card-required" style="display: none;">*</span>:</label>
              {{ card_form.expiration_date }}
              {% if card_form.expiration_date.errors %}
                <div class="form-errors">{{ card_form.expiration_date.errors }}</div>
              {% endif %}
            </div>
            
            <div>
              <label for="{{ card_form.cvv.id_for_label }}">CVV <span class="required-indicator card-required" style="display: none;">*</span>:</label>
              {{ card_form.cvv }}
              {% if card_form.cvv.help_text %}
                <div class="field-help-text">{{ card_form.cvv.help_text }}</div>
              {% endif %}
              {% if card_form.cvv.errors %}
                <div class="form-errors">{{ card_form.cvv.errors }}</div>
              {% endif %}
            </div>
          </div>
          
          <div class="card-form-full">
            <label for="{{ card_form.zipcode.id_for_label }}">ZIP Code <span class="required-indicator card-required" style="display: none;">*</span>:</label>
            {{ card_form.zipcode }}
            {% if card_form.zipcode.errors %}
              <div class="form-errors">{{ card_form.zipcode.errors }}</div>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>

      <button type="button" class="btn-secondary" onclick="addCard()" id="add-card-btn">+ Add Payment Card</button>

      <button type="submit" class="btn-primary">Create Account</button>
    </form>

    <p class="link-text">
      Already have an account? <a href="{% url 'login' %}">Login here</a>
    </p>
  </div>
</main>

<script>
function toggleRequiredIndicators(cardForm, show) {
  const indicators = cardForm.querySelectorAll('.card-required');
  indicators.forEach(indicator => {
    indicator.style.display = show ? 'inline' : 'none';
  });
}

function setupCardValidation(cardForm) {
  const inputs = cardForm.querySelectorAll('input[type="text"], input[type="password"], select');
  
  inputs.forEach(input => {
    input.addEventListener('input', function() {
      const hasAnyData = Array.from(inputs).some(inp => inp.value.trim() !== '');
      toggleRequiredIndicators(cardForm, hasAnyData);
      
      // Update input validation attributes
      inputs.forEach(inp => {
        if (hasAnyData) {
          inp.setAttribute('data-required', 'true');
          inp.style.borderColor = inp.value.trim() === '' ? 'rgba(255, 69, 0, 0.6)' : 'rgba(220, 20, 60, 0.3)';
        } else {
          inp.removeAttribute('data-required');
          inp.style.borderColor = 'rgba(220, 20, 60, 0.3)';
        }
      });
    });
    
    // Trigger validation on blur
    input.addEventListener('blur', function() {
      if (input.getAttribute('data-required') === 'true' && input.value.trim() === '') {
        input.style.borderColor = 'rgba(255, 69, 0, 0.6)';
      }
    });
    
    // Reset border on focus
    input.addEventListener('focus', function() {
      input.style.borderColor = '#DC143C';
    });
  });
}

function updateCardCount() {
  const existingCards = document.querySelectorAll('.existing-card').length;
  const addButton = document.getElementById('add-card-btn');
  
  if (existingCards >= maxCards) {
    addButton.style.display = 'none';
  } else {
    addButton.style.display = 'block';
  }
}

const maxCards = 4;

function addCard() {
  const existingCards = document.querySelectorAll('.existing-card').length;
  if (existingCards >= maxCards) {
    alert('Maximum 4 payment cards allowed');
    return;
  }

  const hiddenCards = document.querySelectorAll('.hidden-card');
  if (hiddenCards.length > 0) {
    const cardForm = hiddenCards[0];
    cardForm.classList.remove('hidden-card');
    cardForm.classList.add('existing-card');

    const inputs = cardForm.querySelectorAll('input, select');
    inputs.forEach(input => {
      input.disabled = false;
    });

    // Setup validation for the new card
    setupCardValidation(cardForm);

    // Disable unused hidden card forms
    document.querySelectorAll('.hidden-card').forEach(hiddenForm => {
      hiddenForm.querySelectorAll('input, select').forEach(input => {
        input.disabled = true;
      });
    });
  }

  updateCardCount();
}

function removeCard(cardIndex) {
  // Don't allow removing the first card
  if (cardIndex === '0') {
    // For the first card, just clear the values but keep it visible
    const cardForm = document.getElementById(`card-form-${cardIndex}`);
    const inputs = cardForm.querySelectorAll('input, select');
    inputs.forEach(input => {
      input.value = '';
      input.style.borderColor = 'rgba(220, 20, 60, 0.3)';
      input.removeAttribute('data-required');
    });
    toggleRequiredIndicators(cardForm, false);
    return;
  }

  const cardForm = document.getElementById(`card-form-${cardIndex}`);
  if (cardForm) {
    cardForm.classList.remove('existing-card');
    cardForm.classList.add('hidden-card');

    const inputs = cardForm.querySelectorAll('input, select');
    inputs.forEach(input => {
      input.value = '';
      input.disabled = true;
      input.style.borderColor = 'rgba(220, 20, 60, 0.3)';
      input.removeAttribute('data-required');
    });
    
    toggleRequiredIndicators(cardForm, false);
  }

  updateCardCount();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Disable hidden card forms
  document.querySelectorAll('.hidden-card').forEach(cardForm => {
    const inputs = cardForm.querySelectorAll('input, select');
    inputs.forEach(input => {
      input.disabled = true;
    });
  });

  // Setup validation for existing cards
  document.querySelectorAll('.existing-card').forEach(cardForm => {
    setupCardValidation(cardForm);
    
    // Check if they have data to show required indicators
    const inputs = cardForm.querySelectorAll('input[type="text"], input[type="password"], select');
    const hasData = Array.from(inputs).some(input => input.value.trim() !== '');
    if (hasData) {
      toggleRequiredIndicators(cardForm, true);
    }
  });

  updateCardCount();
});

// Form validation on submit
document.querySelector('form').addEventListener('submit', function(e) {
  let isValid = true;
  const errorMessages = [];

  // Validate active card forms
  document.querySelectorAll('.existing-card').forEach((cardForm, index) => {
    const inputs = cardForm.querySelectorAll('input[type="text"], input[type="password"], select');
    const hasAnyData = Array.from(inputs).some(input => input.value.trim() !== '');
    
    if (hasAnyData) {
      // If any field has data, all fields are required
      inputs.forEach(input => {
        if (input.value.trim() === '' && !input.disabled) {
          isValid = false;
          input.style.borderColor = 'rgba(255, 69, 0, 0.8)';
          errorMessages.push(`Payment Card ${index + 1}: All fields are required when adding a card`);
        }
      });
    }
  });

  if (!isValid) {
    e.preventDefault();
    alert('Please fill in all required fields:\n' + errorMessages.join('\n'));
    
    // Scroll to first error
    const firstError = document.querySelector('input[style*="255, 69, 0"]');
    if (firstError) {
      firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      firstError.focus();
    }
  }
});
</script>

</body>
</html>