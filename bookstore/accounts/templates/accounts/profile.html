{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Your Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
  min-height: 100vh;
}

.auth-page {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px 20px;
  position: relative;
}

.auth-box {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(20px);
  border-radius: 30px;
  padding: 50px 40px;
  width: 100%;
  max-width: 550px;
  border: 1px solid rgba(220, 20, 60, 0.2);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  position: relative;
  overflow: hidden;
}

.auth-box h2 {
  text-align: center;
  font-size: 2.2em;
  font-weight: 800;
  margin-bottom: 30px;
  background: linear-gradient(45deg, #DC143C, #FF6B6B);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  position: relative;
}

.auth-box form label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.9);
}

.auth-box form input, .auth-box form textarea, .auth-box form select {
  width: 100%;
  padding: 15px 20px;
  border-radius: 25px;
  border: 2px solid rgba(220, 20, 60, 0.3);
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  color: white;
  font-size: 1em;
  margin-bottom: 20px;
  box-sizing: border-box;
}

.auth-box form input:focus, .auth-box form textarea:focus, .auth-box form select:focus {
  outline: none;
  border-color: #DC143C;
  box-shadow: 0 0 20px rgba(220, 20, 60, 0.3);
}

.auth-box form input[readonly] {
  background: rgba(255, 255, 255, 0.05);
  border-color: rgba(220, 20, 60, 0.2);
  cursor: not-allowed;
  opacity: 0.7;
}

.btn-primary {
  width: 100%;
  padding: 15px;
  background: linear-gradient(45deg, #DC143C, #FF6B6B);
  color: white;
  border: none;
  border-radius: 25px;
  font-weight: 700;
  font-size: 1.1em;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-top: 20px;
}

.btn-primary:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 25px rgba(220, 20, 60, 0.4);
}

.btn-secondary {
  padding: 10px 20px;
  background: rgba(255, 255, 255, 0.1);
  color: white;
  border: 2px solid rgba(220, 20, 60, 0.3);
  border-radius: 20px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-top: 10px;
}

.btn-secondary:hover {
  background: rgba(220, 20, 60, 0.2);
  border-color: #DC143C;
}

.btn-remove {
  background: rgba(255, 69, 0, 0.2);
  border: 2px solid rgba(255, 69, 0, 0.4);
  color: #FF6B6B;
  padding: 8px 16px;
  border-radius: 15px;
  cursor: pointer;
  font-size: 0.9em;
  margin-top: 10px;
}

.btn-remove:hover {
  background: rgba(255, 69, 0, 0.3);
}

.navbar {
  background: rgba(15, 15, 15, 0.95);
  backdrop-filter: blur(20px);
  padding: 20px 40px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 1000;
  border-bottom: 1px solid rgba(220, 20, 60, 0.3);
}

.logo {
  font-size: 1.8em;
  font-weight: 800;
  background: linear-gradient(45deg, #DC143C, #FF6B6B);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.nav-buttons {
  display: flex;
  gap: 15px;
}

.btn-nav {
  padding: 10px 20px;
  background: rgba(255, 255, 255, 0.1);
  color: white;
  text-decoration: none;
  border-radius: 25px;
  font-weight: 600;
  transition: all 0.3s ease;
  border: 1px solid rgba(220, 20, 60, 0.3);
}

.btn-nav:hover {
  background: rgba(220, 20, 60, 0.2);
  box-shadow: 0 5px 15px rgba(220, 20, 60, 0.2);
  border-color: #DC143C;
}

.link-text {
  text-align: center;
  margin-top: 25px;
  color: rgba(255, 255, 255, 0.8);
  font-size: 0.95em;
}

.link-text a {
  color: #DC143C;
  text-decoration: none;
  font-weight: 600;
}

.card-section {
  margin-bottom: 20px;
  padding: 20px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 20px;
  border: 1px solid rgba(220, 20, 60, 0.2);
}

.card-count {
  color: rgba(255, 255, 255, 0.7);
  font-size: 0.9em;
  margin-bottom: 10px;
}

.user-info {
  background: rgba(255, 255, 255, 0.05);
  padding: 20px;
  border-radius: 20px;
  margin-bottom: 20px;
  border: 1px solid rgba(220, 20, 60, 0.2);
}

.user-info p {
  margin: 10px 0;
  color: rgba(255, 255, 255, 0.9);
}

.user-info strong {
  color: #FF6B6B;
}

.floating-shape {
  position: absolute;
  background: linear-gradient(45deg, rgba(220, 20, 60, 0.1), rgba(139, 0, 0, 0.1));
  border-radius: 50%;
  animation: float 6s ease-in-out infinite;
}

.floating-shape:nth-child(1) {
  width: 100px;
  height: 100px;
  top: 20%;
  left: 10%;
  animation-delay: 0s;
}

.floating-shape:nth-child(2) {
  width: 150px;
  height: 150px;
  top: 50%;
  right: 20%;
  animation-delay: 2s;
}

.floating-shape:nth-child(3) {
  width: 80px;
  height: 80px;
  bottom: 30%;
  left: 30%;
  animation-delay: 4s;
}

@keyframes float {
  0%, 100% { transform: translateY(0px) rotate(0deg); }
  50% { transform: translateY(-20px) rotate(180deg); }
}

.messages {
  list-style: none;
  padding: 0;
  margin-bottom: 20px;
}

.messages li {
  background: rgba(220, 20, 60, 0.1);
  border: 1px solid rgba(220, 20, 60, 0.3);
  color: #FF6B6B;
  padding: 12px 20px;
  border-radius: 20px;
  margin-bottom: 10px;
  font-size: 0.9em;
  backdrop-filter: blur(10px);
}

h3 {
  color: white;
  margin: 25px 0 15px 0;
  font-size: 1.3em;
}

hr {
  margin: 20px 0;
  border: none;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
}

.hidden-card {
  display: none;
}

.existing-card {
  display: block;
}

.form-errors {
  color: #FF6B6B;
  font-size: 0.9em;
  margin-top: 5px;
  margin-bottom: 10px;
}

.required-indicator {
  color: #FF6B6B;
  font-weight: bold;
}

.card-form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.card-form-full {
  grid-column: 1 / -1;
}

.checkbox-wrapper {
  display: flex;
  align-items: center;
  margin-top: 15px;
  margin-bottom: 20px;
}

.checkbox-wrapper input[type="checkbox"] {
  width: auto;
  margin-right: 10px;
  margin-bottom: 0;
}

.checkbox-wrapper label {
  margin-bottom: 0;
  display: flex;
  align-items: center;
  cursor: pointer;
}

.field-help-text {
  font-size: 0.8em;
  color: rgba(255, 255, 255, 0.6);
  margin-top: -15px;
  margin-bottom: 15px;
  font-style: italic;
}
</style>
</head>
<body>
<!-- Floating background shapes -->
<div class="floating-shape"></div>
<div class="floating-shape"></div>
<div class="floating-shape"></div>

<header class="navbar">
<div class="logo">Bookstore</div>
<div class="nav-buttons">
<a href="{% url 'store_home' %}" class="btn-nav">Home</a>
<a href="{% url 'cart_view' %}" class="btn-nav">Cart</a>
<a href="{% url 'logout' %}" class="btn-nav">Logout</a>
</div>
</header>

<main class="auth-page">
<div class="auth-box">
<h2>👤 Profile</h2>

<div class="user-info">
  <p><strong>Name:</strong> {{ user.first_name }} {{ user.last_name }}</p>
  <p><strong>Email:</strong> {{ user.email }}</p>
  <p><strong>Account ID:</strong> {{ user.account_id }}</p>
  {% if user.status %}
  <p><strong>Status:</strong> {{ user.status }}</p>
  {% endif %}
</div>

{% if messages %}
<ul class="messages">
{% for message in messages %}
<li>{{ message }}</li>
{% endfor %}
</ul>
{% endif %}

<!-- DEBUG: Display form errors -->
{% if profile_form.errors or address_form.errors %}
<div class="form-errors">
  <h4>Form Errors:</h4>
  {% if profile_form.errors %}
    <p>Profile errors: {{ profile_form.errors }}</p>
  {% endif %}
  {% if address_form.errors %}
    <p>Address errors: {{ address_form.errors }}</p>
  {% endif %}
  {% for form in card_forms %}
    {% if form.errors %}
      <p>Card {{ forloop.counter0 }} errors: {{ form.errors }}</p>
    {% endif %}
  {% endfor %}
</div>
{% endif %}

<form method="post">
{% csrf_token %}

<h3>Update Personal Info</h3>
<label for="{{ profile_form.first_name.id_for_label }}">First Name:</label>
{{ profile_form.first_name }}
{% if profile_form.first_name.errors %}
  <div class="form-errors">{{ profile_form.first_name.errors }}</div>
{% endif %}

<label for="{{ profile_form.last_name.id_for_label }}">Last Name:</label>
{{ profile_form.last_name }}
{% if profile_form.last_name.errors %}
  <div class="form-errors">{{ profile_form.last_name.errors }}</div>
{% endif %}

<label for="{{ profile_form.phone.id_for_label }}">Phone:</label>
{{ profile_form.phone }}
{% if profile_form.phone.errors %}
  <div class="form-errors">{{ profile_form.phone.errors }}</div>
{% endif %}

<div class="checkbox-wrapper">
  {{ profile_form.promotions_opt_in }}
  <label for="{{ profile_form.promotions_opt_in.id_for_label }}">
    Register for Promotions
  </label>
</div>

<h3>Shipping Address</h3>
<label for="{{ address_form.street.id_for_label }}">Street Address:</label>
{{ address_form.street }}
{% if address_form.street.errors %}
  <div class="form-errors">{{ address_form.street.errors }}</div>
{% endif %}

<label for="{{ address_form.city.id_for_label }}">City:</label>
{{ address_form.city }}
{% if address_form.city.errors %}
  <div class="form-errors">{{ address_form.city.errors }}</div>
{% endif %}

<label for="{{ address_form.state.id_for_label }}">State:</label>
{{ address_form.state }}
{% if address_form.state.errors %}
  <div class="form-errors">{{ address_form.state.errors }}</div>
{% endif %}

<label for="{{ address_form.zip_code.id_for_label }}">ZIP Code:</label>
{{ address_form.zip_code }}
{% if address_form.zip_code.errors %}
  <div class="form-errors">{{ address_form.zip_code.errors }}</div>
{% endif %}

<label for="{{ address_form.country.id_for_label }}">Country:</label>
{{ address_form.country }}
{% if address_form.country.errors %}
  <div class="form-errors">{{ address_form.country.errors }}</div>
{% endif %}

<h3>Payment Cards</h3>
<div class="card-count">You can manage up to 4 payment cards</div>

<div id="card-container">
  {% for card_form in card_forms %}
  <div class="card-form card-section {% if card_form.instance.pk %}existing-card{% else %}hidden-card{% endif %}" id="card-form-{{ forloop.counter0 }}" data-is-existing="{% if card_form.instance.pk %}true{% else %}false{% endif %}">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <strong style="color: white;">
        {% if card_form.instance.pk %}
          {{ card_form.instance.card_type }} ending in {{ card_form.instance.last4 }}
        {% else %}
          Payment Card {{ forloop.counter }}
        {% endif %}
      </strong>
      <button type="button" class="btn-remove" onclick="removeCard('{{ forloop.counter0 }}', '{{ card_form.instance.pk }}')">Remove</button>
    </div>
    
    <div class="card-form-grid">
      <div>
        <label for="{{ card_form.card_type.id_for_label }}">Card Type {% if not card_form.instance.pk %}<span class="required-indicator card-required" style="display: none;">*</span>{% endif %}:</label>
        {{ card_form.card_type }}
        {% if card_form.card_type.errors %}
          <div class="form-errors">{{ card_form.card_type.errors }}</div>
        {% endif %}
      </div>
      
      <div>
        <label for="{{ card_form.name.id_for_label }}">Name on Card {% if not card_form.instance.pk %}<span class="required-indicator card-required" style="display: none;">*</span>{% endif %}:</label>
        {{ card_form.name }}
        {% if card_form.name.errors %}
          <div class="form-errors">{{ card_form.name.errors }}</div>
        {% endif %}
      </div>
    </div>
    
    <div class="card-form-full">
      <label for="{{ card_form.card_number.id_for_label }}">Card Number {% if not card_form.instance.pk %}<span class="required-indicator card-required" style="display: none;">*</span>{% endif %}:</label>
      {{ card_form.card_number }}
      {% if card_form.card_number.help_text %}
        <div class="field-help-text">{{ card_form.card_number.help_text }}</div>
      {% endif %}
      {% if card_form.card_number.errors %}
        <div class="form-errors">{{ card_form.card_number.errors }}</div>
      {% endif %}
    </div>
    
    <div class="card-form-grid">
      <div>
        <label for="{{ card_form.expiration_date.id_for_label }}">Expiration Date {% if not card_form.instance.pk %}<span class="required-indicator card-required" style="display: none;">*</span>{% endif %}:</label>
        {{ card_form.expiration_date }}
        {% if card_form.expiration_date.errors %}
          <div class="form-errors">{{ card_form.expiration_date.errors }}</div>
        {% endif %}
      </div>
      
      <div>
  <label for="{{ card_form.cvv.id_for_label }}">CVV {% if not card_form.instance.pk %}<span class="required-indicator card-required" style="display: none;">*</span>{% endif %}:</label>
  {{ card_form.cvv }}
  {% if card_form.cvv.help_text %}
    <div class="field-help-text">{{ card_form.cvv.help_text }}</div>
  {% endif %}
  {% if card_form.cvv.errors %}
    <div class="form-errors">{{ card_form.cvv.errors }}</div>
  {% endif %}
</div>
    </div>
    
    <div class="card-form-full">
      <label for="{{ card_form.zipcode.id_for_label }}">ZIP Code {% if not card_form.instance.pk %}<span class="required-indicator card-required" style="display: none;">*</span>{% endif %}:</label>
      {{ card_form.zipcode }}
      {% if card_form.zipcode.errors %}
        <div class="form-errors">{{ card_form.zipcode.errors }}</div>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

<button type="button" class="btn-secondary" onclick="addCard()" id="add-card-btn">+ Add Payment Card</button>

<h3>Change Password</h3>
<label for="{{ password_form.old_password.id_for_label }}">Current Password:</label>
{{ password_form.old_password }}
{% if password_form.old_password.errors %}
  <div class="form-errors">{{ password_form.old_password.errors }}</div>
{% endif %}

<label for="{{ password_form.new_password1.id_for_label }}">New Password:</label>
{{ password_form.new_password1 }}
{% if password_form.new_password1.errors %}
  <div class="form-errors">{{ password_form.new_password1.errors }}</div>
{% endif %}

<label for="{{ password_form.new_password2.id_for_label }}">Confirm New Password:</label>
{{ password_form.new_password2 }}
{% if password_form.new_password2.errors %}
  <div class="form-errors">{{ password_form.new_password2.errors }}</div>
{% endif %}

<button type="submit" class="btn-primary">Save Changes</button>
</form>

<p class="link-text">
<a href="{% url 'store_home' %}">← Back to Home</a>
</p>
</div>
</main>

<script>
function getCSRFToken() {
  let name = 'csrftoken';
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function updateCardCount() {
  const existingCards = document.querySelectorAll('.existing-card').length;
  const addButton = document.getElementById('add-card-btn');
  
  if (existingCards >= maxCards) {
    addButton.style.display = 'none';
  } else {
    addButton.style.display = 'block';
  }
}

function toggleRequiredIndicators(cardForm, show) {
  const indicators = cardForm.querySelectorAll('.card-required');
  indicators.forEach(indicator => {
    indicator.style.display = show ? 'inline' : 'none';
  });
}

function isExistingCard(cardForm) {
  return cardForm.getAttribute('data-is-existing') === 'true';
}

function setupCardValidation(cardForm) {
  const isExisting = isExistingCard(cardForm);
  const inputs = cardForm.querySelectorAll('input[type="text"], input[type="password"]');
  
  // For existing cards, don't set up the same validation as new cards
  if (isExisting) {
    // For existing cards, only validate when they're actually being updated
    inputs.forEach(input => {
      input.addEventListener('input', function() {
        // Don't change border colors for readonly fields
        if (!input.hasAttribute('readonly')) {
          input.style.borderColor = 'rgba(220, 20, 60, 0.3)';
        }
      });
      
      input.addEventListener('focus', function() {
        if (!input.hasAttribute('readonly')) {
          input.style.borderColor = '#DC143C';
        }
      });
    });
    return;
  }
  
  // For new cards, use the original validation logic
  inputs.forEach(input => {
    input.addEventListener('input', function() {
      const hasAnyData = Array.from(inputs).some(inp => inp.value.trim() !== '');
      toggleRequiredIndicators(cardForm, hasAnyData);
      
      // Update input validation attributes
      inputs.forEach(inp => {
        if (hasAnyData) {
          inp.setAttribute('data-required', 'true');
          inp.style.borderColor = inp.value.trim() === '' ? 'rgba(255, 69, 0, 0.6)' : 'rgba(220, 20, 60, 0.3)';
        } else {
          inp.removeAttribute('data-required');
          inp.style.borderColor = 'rgba(220, 20, 60, 0.3)';
        }
      });
    });
    
    // Trigger validation on blur
    input.addEventListener('blur', function() {
      if (input.getAttribute('data-required') === 'true' && input.value.trim() === '') {
        input.style.borderColor = 'rgba(255, 69, 0, 0.6)';
      }
    });
    
    // Reset border on focus
    input.addEventListener('focus', function() {
      input.style.borderColor = '#DC143C';
    });
  });
}

const maxCards = 4;

function addCard() {
  const existingCards = document.querySelectorAll('.existing-card').length;
  if (existingCards >= maxCards) {
    alert('Maximum 4 payment cards allowed');
    return;
  }

  const hiddenCards = document.querySelectorAll('.hidden-card');
  if (hiddenCards.length > 0) {
    const cardForm = hiddenCards[0];
    cardForm.classList.remove('hidden-card');
    cardForm.classList.add('existing-card');

    const inputs = cardForm.querySelectorAll('input, select');
    inputs.forEach(input => {
      input.disabled = false;
    });

    // Setup validation for the new card
    setupCardValidation(cardForm);

    // Disable unused hidden card forms
    document.querySelectorAll('.hidden-card').forEach(hiddenForm => {
      hiddenForm.querySelectorAll('input, select').forEach(input => {
        input.disabled = true;
      });
    });
  }

  updateCardCount();
}

function removeCard(cardIndex, cardId) {
  const cardForm = document.getElementById(`card-form-${cardIndex}`);

  if (!cardId || cardId === "None") {
    if (cardForm) {
      cardForm.classList.remove('existing-card');
      cardForm.classList.add('hidden-card');

      const inputs = cardForm.querySelectorAll('input, select');
      inputs.forEach(input => {
        input.value = '';
        input.disabled = true;
        input.style.borderColor = 'rgba(220, 20, 60, 0.3)';
        input.removeAttribute('data-required');
        input.removeAttribute('readonly');
      });
      
      toggleRequiredIndicators(cardForm, false);
    }
    updateCardCount();
    return;
  }

  if (confirm('Are you sure you want to delete this payment card?')) {
    fetch(`/accounts/delete-card/${cardId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRFToken(),
      },
    }).then(response => response.json())
      .then(data => {
        if (data.success) {
          if (cardForm) {
            cardForm.classList.remove('existing-card');
            cardForm.classList.add('hidden-card');

            const inputs = cardForm.querySelectorAll('input, select');
            inputs.forEach(input => {
              input.value = '';
              input.disabled = true;
              input.style.borderColor = 'rgba(220, 20, 60, 0.3)';
              input.removeAttribute('data-required');
              input.removeAttribute('readonly');
            });
            
            toggleRequiredIndicators(cardForm, false);
            
            // Reset the card form to be a new card template
            cardForm.setAttribute('data-is-existing', 'false');
          }
          updateCardCount();
        } else {
          alert(data.error || "Failed to delete card.");
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert("An error occurred while deleting the card.");
      });
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Disable hidden card forms
  document.querySelectorAll('.hidden-card').forEach(cardForm => {
    const inputs = cardForm.querySelectorAll('input, select');
    inputs.forEach(input => {
      input.disabled = true;
    });
  });

  // Setup validation for existing cards
  document.querySelectorAll('.existing-card').forEach(cardForm => {
    setupCardValidation(cardForm);
    
    // For new cards (not existing), check if they have data to show required indicators
    if (!isExistingCard(cardForm)) {
      const inputs = cardForm.querySelectorAll('input[type="text"], input[type="password"]');
      const hasData = Array.from(inputs).some(input => input.value.trim() !== '');
      if (hasData) {
        toggleRequiredIndicators(cardForm, true);
      }
    }
  });

  updateCardCount();
});

document.querySelector('form').addEventListener('submit', function(e) {
  let isValid = true;
  const errorMessages = [];

  // Validate active card forms
  document.querySelectorAll('.existing-card').forEach((cardForm, index) => {
    const isExisting = isExistingCard(cardForm);
    
    if (isExisting) {
      // For existing cards, CVV is completely optional
      // No validation needed for existing cards
      // Users can update any field without requiring CVV
    } else {
      // For new cards, use the original validation logic
      const inputs = cardForm.querySelectorAll('input[type="text"], input[type="password"]');
      const hasAnyData = Array.from(inputs).some(input => input.value.trim() !== '');
      
      if (hasAnyData) {
        // If any field has data, all fields are required
        inputs.forEach(input => {
          if (input.value.trim() === '' && !input.disabled) {
            isValid = false;
            input.style.borderColor = 'rgba(255, 69, 0, 0.8)';
            errorMessages.push(`Payment Card ${index + 1}: All fields are required when adding a card`);
          }
        });
      }
    }
  });

  if (!isValid) {
    e.preventDefault();
    alert('Please fill in all required fields:\n' + errorMessages.join('\n'));
    
    // Scroll to first error
    const firstError = document.querySelector('input[style*="255, 69, 0"]');
    if (firstError) {
      firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      firstError.focus();
    }
  }
});
</script>

</body>
</html>